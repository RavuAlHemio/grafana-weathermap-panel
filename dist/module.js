define(["app/plugins/sdk","lodash","app/core/time_series2"],((e,t,r)=>(()=>{"use strict";var n={840:e=>{e.exports=r},256:t=>{t.exports=e},804:e=>{e.exports=t}},a={};function i(e){var t=a[e];if(void 0!==t)return t.exports;var r=a[e]={exports:{}};return n[e](r,r.exports,i),r.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};return(()=>{i.r(o),i.d(o,{PanelCtrl:()=>M});var e=i(256),t="http://www.w3.org/2000/svg";function r(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}function n(e,t,n,a){if(null===t){if(null===n){var i=r(e,a);return[e,e,i,i,i,a,a]}t=e}null===n&&(n=a);var o=r(e,t),s=r(t,n),l=r(n,a),p=r(o,s),u=r(s,l);return[e,o,p,r(p,u),u,l,a]}function a(e,t){return null===e&&(e=0),null===t&&(t=0),{x:t*Math.cos(e),y:t*Math.sin(e)}}function s(e){for(;e<=-Math.PI;)e+=2*Math.PI;for(;e>Math.PI;)e-=2*Math.PI;return e}function l(e){return e*Math.PI/180}var p="pink";function u(e,t,r){return"linear"===e.type?function(e,t,r){if(0===e.length)return p;var n=e[e.length-1],a=0,i=0,o=0;if(r<e[0].position)return""+e[0][t];if(r>=n.position)return""+n[t];for(var s=!1,l=0;l<e.length-1;++l)if(r>=e[l].position&&r<e[l+1].position){var u=e[l].position,h=Number.parseInt((""+e[l][t]).substr(1,2),16),f=Number.parseInt((""+e[l][t]).substr(3,2),16),c=Number.parseInt((""+e[l][t]).substr(5,2),16),y=e[l+1].position,m=Number.parseInt((""+e[l+1][t]).substr(1,2),16),v=Number.parseInt((""+e[l+1][t]).substr(3,2),16),g=Number.parseInt((""+e[l+1][t]).substr(5,2),16);a=d(r,u,y,h,m),i=d(r,u,y,f,v),o=d(r,u,y,c,g),s=!0;break}if(!s)return p;return"rgb("+Math.floor(a)+", "+Math.floor(i)+", "+Math.floor(o)+")"}(e.stops,t,r):"steps"===e.type?function(e,t,r){if(0===e.length)return p;var n=e[e.length-1];if(r<e[0].position)return""+e[0][t];if(r>=n.position)return""+n[t];for(var a=0;a<e.length-1;++a)if(r>=e[a].position&&r<e[a+1].position)return""+e[a][t];return p}(e.stops,t,r):p}function d(e,t,r,n,a){return n===a?n:(e<t&&(e=t),e>r&&(e=r),n+(e-t)/(r-t)*(a-n))}var h=100;function f(e,t,r,n,a,i){var o="";if(""!==t.type){var s=e.g();r.appendChild(s),s.setAttribute("class","stroke-legend"),"h"===t.type[0]?o="translate("+t.x+" "+t.y+") scale("+t.length/h+" "+t.width/5+")":"v"===t.type[0]&&(o="translate("+t.x+" "+(t.y+t.length)+") rotate(-90) scale("+t.length/h+" "+t.width/5+")"),s.setAttribute("transform",o),c(e,a,"strokeColor",s,n,i);var l=e.g();r.appendChild(l),s.setAttribute("class","fill-legend"),"h"===t.type[0]?o="translate("+t.x+" "+(t.y+t.width)+") scale("+t.length/h+" "+t.width/5+")":"v"===t.type[0]&&(o="translate("+(t.x+t.width)+" "+(t.y+t.length)+") rotate(-90) scale("+t.length/h+" "+t.width/5+")"),l.setAttribute("transform",o),c(e,a,"fillColor",l,n,i),function(e,t,r,n){if(""===t.type||"n"===t.type[1])return;for(var a=0,i=r.stops;a<i.length;a++){var o=i[a];if(o.showLegendLabel){var s=t.x,l=t.y,p=0,u="start";"h"===t.type[0]?(s+=o.position*t.length/h,u="middle","hb"===t.type&&(l+=2*t.width,p=1)):"v"===t.type[0]&&(l+=t.length-o.position*t.length/h,p=.4,"vl"===t.type?u="end":"vr"===t.type&&(u="start",s+=2*t.width));var d=e.text();n.appendChild(d),d.setAttribute("class","legend-label"),d.setAttribute("x",""+s),d.setAttribute("y",""+l),d.setAttribute("dy",p+"em"),d.setAttribute("style","text-anchor:"+u),d.textContent=""+o.position}}}(e,t,a,r)}}function c(e,t,r,n,a,i){if("linear"===t.type){var o="WeathermapLegendGradient-"+r;null!=i&&(o=o+"-"+i);var s=e.linearGradient();a.appendChild(s),s.setAttribute("id",o);for(var l=0,p=t.stops;l<p.length;l++){var u=p[l],d=e.stop();s.appendChild(d),d.setAttribute("offset",u.position+"%"),d.setAttribute("stop-color",""+u[r])}var f=e.rect();n.appendChild(f),g(f,0,0,h,5),f.setAttribute("style","fill:url(#"+o+")")}else if("steps"===t.type){for(var c=1;c<t.stops.length;++c){var y=e.rect();n.appendChild(y),g(y,t.stops[c-1].position,0,t.stops[c].position-t.stops[c-1].position,5),y.setAttribute("style","fill:"+t.stops[c-1][r])}var m=e.rect();n.appendChild(m),g(m,t.stops[t.stops.length-1].position,0,100-t.stops[t.stops.length-1].position,5),m.setAttribute("style","fill:"+t.stops[t.stops.length-1][r])}}function y(e,t,r,i,o,p){void 0===p&&(p=!1);var d=r.gradient.stops.slice().sort((function(e,t){return e.position-t.position})),h={type:r.gradient.type,stops:d},c=new w(e,r,h,i);return function(e,t,r){void 0===r&&(r=!1);e.svg=e.make.svg(),b(e.svg,{width:e.config.canvasSize.width+"px",height:e.config.canvasSize.height+"px"}),r&&e.svg.setAttribute("viewBox","0 0 "+e.config.canvasSize.width+" "+e.config.canvasSize.height);t.appendChild(e.svg),e.defs=e.make.defs(),e.svg.appendChild(e.defs),e.legendGroup=e.make.g(),e.legendGroup.setAttribute("class","legend"),e.svg.appendChild(e.legendGroup),e.edgeGroup=e.make.g(),e.edgeGroup.setAttribute("class","edges"),e.svg.appendChild(e.edgeGroup),e.nodeGroup=e.make.g(),e.nodeGroup.setAttribute("class","nodes"),e.svg.appendChild(e.nodeGroup),e.labelGroup=e.make.g(),e.labelGroup.setAttribute("class","labels"),e.svg.appendChild(e.labelGroup)}(c,t,p),null!=o&&(c.nodeLinkUriBase=o(r.link.node),c.edgeLinkUriBase=o(r.link.edge)),function(e){for(var t=0,r=e.config.weathermapNodes;t<r.length;t++){var n=r[t];e.nodeLabelToNode[n.label]=n;var a=e.make.g();v(e.make,e.nodeGroup,a,e.nodeLinkUriBase,n.linkParams);var i=e.make.rect();a.appendChild(i),g(i,n.x,n.y,n.width,n.height),b(i,{stroke:"gray","stroke-width":"1px"});var o=e.make.text();if(a.appendChild(o),o.setAttribute("x",""+(+n.x+ +e.config.textOffsets.left)),o.setAttribute("y",""+(+n.y+ +n.height-e.config.textOffsets.bottom)),e.config.showNumbers&&null!=n.metricName){var s=n.metricName in e.currentValues?""+e.currentValues[n.metricName]:"?";o.textContent=n.label+" ("+s+")"}else o.textContent=n.label;var l=null;if(n.metricName?n.metricName in e.currentValues?(l=e.currentValues[n.metricName],b(i,{fill:u(e.sortedGradient,"fillColor",l)})):(b(o,{fill:"white"}),b(i,{fill:"black","stroke-dasharray":e.config.noValueDashArray})):b(i,{fill:"silver","stroke-dasharray":e.config.unmeasuredDashArray}),null!==l){var p=e.make.title();a.insertBefore(p,p.firstChild),p.textContent=n.label+" ("+l.toFixed(2)+")"}}}(c),function(e){for(var t=0,r=e.config.weathermapEdges;t<r.length;t++){var i=r[t],o=e.nodeLabelToNode[i.node1],p=e.nodeLabelToNode[i.node2];if(o&&p){var u=e.make.g();v(e.make,e.edgeGroup,u,e.edgeLinkUriBase,i.linkParams);var d={x:+o.x+ +o.width/2,y:+o.y+ +o.height/2},h={x:+p.x+ +p.width/2,y:+p.y+ +p.height/2},f=null,c=null;if(i.bendDirection&&i.bendMagnitude){var y=Math.atan2(d.y-h.y,h.x-d.x),g=Math.atan2(h.y-d.y,d.x-h.x),b=s(y+l(i.bendDirection)),x=s(g-l(i.bendDirection)),w=a(b,i.bendMagnitude),k=a(x,i.bendMagnitude);f={x:+d.x+w.x,y:+d.y-w.y},c={x:+h.x+k.x,y:+h.y-k.y}}if(i.metric2Name){var C=n(d,f,c,h),N=C[1],A=C[2],S=C[3],G=C[4],E=C[5];m(e,u,d,N,A,S,i.metricName,i.styleName,i.node1+" → "+i.node2),m(e,u,S,G,E,h,i.metric2Name,i.styleName,i.node2+" → "+i.node1)}else m(e,u,d,f,c,h,i.metricName,i.styleName,i.node1+" ↔ "+i.node2)}}}(c),function(e){for(var t=0,r=e.config.weathermapLabels;t<r.length;t++){var n=r[t],a=e.make.g();e.labelGroup.appendChild(a);var i=e.make.text();a.appendChild(i),i.setAttribute("x",""+ +n.x),i.setAttribute("y",""+ +n.y),i.textContent=n.label}}(c),f(c.make,r.legend,c.legendGroup,c.defs,h,""+r.id),c.svg}function m(e,t,r,a,i,o,s,l,p){var d=[e.config.strokeWidth],h=function(e,t){if(!t)return null;var r=e.styleMap[t];if(!r)return null;return r}(e,l);h&&h.strokeWidthArray&&(d=h.strokeWidthArray.split(/[ ,]+/).map((function(e){return Number.parseFloat(e)})));d.length%2!=1&&d.push.apply(d,d);var f,c,y={x:0,y:0};if(d.length>1){var m={x:r.x-o.x,y:r.y-o.y};f={x:m.y,y:-m.x},c=Math.sqrt(f.x*f.x+f.y*f.y),y={x:f.x/c,y:f.y/c}}var v=e.make.g();t.appendChild(v),b(v,{fill:"none"});var g=null;if(null!=s&&s in e.currentValues?(g=e.currentValues[s],b(v,{stroke:u(e.sortedGradient,"strokeColor",g)}),function(e,t,r){if(!r)return;var n={};r.dashArray&&(n["stroke-dasharray"]=r.dashArray);b(t,n)}(0,v,h)):b(v,{stroke:"black","stroke-dasharray":e.config.noValueDashArray}),p){var x=e.make.title();v.appendChild(x),x.textContent=null===g?p:p+" ("+g.toFixed(2)+")"}for(var w=-d.reduce((function(e,t){return e+t}),0)/2,k=!0,C=0,N=d;C<N.length;C++){var A=N[C];if(k=!k)w+=A;else{var S=y.x*(w+A/2),G=y.y*(w+A/2),E={x:r.x+S,y:r.y+G},M=null==a?null:{x:a.x+S,y:a.y+G},L=null==i?null:{x:i.x+S,y:i.y+G},U={x:o.x+S,y:o.y+G},P=e.make.path();v.appendChild(P),null==M||null==L?P.setAttribute("d","M "+E.x+","+E.y+" L "+U.x+","+U.y):P.setAttribute("d","M "+E.x+","+E.y+" C "+M.x+","+M.y+","+L.x+","+L.y+","+U.x+","+U.y),b(P,{"stroke-width":""+A}),w+=A}}if(e.config.showNumbers){var O=n(r,a,i,o)[3],I=null!=s&&s in e.currentValues?e.currentValues[s].toFixed(2):"?",D=e.make.text();t.appendChild(D),D.setAttribute("x",""+O.x),D.setAttribute("y",""+O.y),D.textContent=I}}function v(e,t,r,n,a){if(null!=n){var i=n;null!=a&&(i+=-1===i.indexOf("?")?"?":"&",i+=a);var o=e.a();t.appendChild(o),o.setAttributeNS("http://www.w3.org/1999/xlink","href",i),o.appendChild(r)}else t.appendChild(r)}function g(e,t,r,n,a){e.setAttribute("x",""+t),e.setAttribute("y",""+r),e.setAttribute("width",""+n),e.setAttribute("height",""+a)}function b(e,t){var r={};if(e.hasAttribute("style")){var n=e.getAttribute("style");if(null!=n)for(var a=0,i=n.split(";");a<i.length;a++){var o=i[a],s=o.indexOf(":");if(-1!==s){var l=o.substr(0,s),p=o.substr(s+1);r[l]=p}}}for(var l in t)t.hasOwnProperty(l)&&(null===t[l]?delete r[l]:r[l]=t[l]);var u=[];for(var l in r)r.hasOwnProperty(l)&&u.push(l+":"+r[l]);var d=u.join(";");e.setAttribute("style",d)}var x,w=function(e,t,r,n){if(this.make=new k(e),this.config=t,this.sortedGradient=r,this.currentValues=n,this.nodeLabelToNode={},this.nodeLinkUriBase=null,this.edgeLinkUriBase=null,this.svg=null,this.defs=null,this.edgeGroup=null,this.nodeGroup=null,this.labelGroup=null,this.legendGroup=null,this.styleMap={},t.weathermapStyles)for(var a=0,i=t.weathermapStyles;a<i.length;a++){var o=i[a];this.styleMap[o.name]=o}},k=function(){function e(e){this.maker=e}return e.prototype.a=function(){return this.maker.createElementNS(t,"a")},e.prototype.defs=function(){return this.maker.createElementNS(t,"defs")},e.prototype.g=function(){return this.maker.createElementNS(t,"g")},e.prototype.linearGradient=function(){return this.maker.createElementNS(t,"linearGradient")},e.prototype.path=function(){return this.maker.createElementNS(t,"path")},e.prototype.rect=function(){return this.maker.createElementNS(t,"rect")},e.prototype.stop=function(){return this.maker.createElementNS(t,"stop")},e.prototype.svg=function(){return this.maker.createElementNS(t,"svg")},e.prototype.text=function(){return this.maker.createElementNS(t,"text")},e.prototype.title=function(){return this.maker.createElementNS(t,"title")},e}(),C=i(804),N=i.n(C),A=i(840),S=i.n(A),G=(x=function(e,t){return(x=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}x(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),E={weathermapNodes:[],weathermapEdges:[],weathermapLabels:[],weathermapStyles:[],canvasSize:{width:800,height:600},textOffsets:{left:5,bottom:5},showNumbers:!1,valueName:"max",nullPointMode:"connected",strokeWidth:1,gradient:{type:"steps",stops:[]},legend:{type:"",x:0,y:0,length:100,width:5},link:{node:{type:"none",absoluteUri:null,dashboard:null,dashUri:null},edge:{type:"none",absoluteUri:null,dashboard:null,dashUri:null}},noValueDashArray:"4 4",unmeasuredDashArray:"4 2"},M=function(e){function t(t,r,n){var a=e.call(this,t,r)||this;return a.backendSrv=n,N().defaultsDeep(a.panel,E),a.currentValues={},a.events.on("init-edit-mode",a.onInitEditMode.bind(a)),a.events.on("data-received",a.onDataReceived.bind(a)),a.events.on("data-snapshot-load",a.onDataSnapshotLoad.bind(a)),a.searchDashboards=function(e,t){n.search({query:e}).then((function(e){var r=N().map(e,(function(e){return e.title}));t(r)}))},a}return t.$inject=["$scope","$injector","backendSrv"],G(t,e),t.prototype.onInitEditMode=function(){this.addEditorTab("Options","public/plugins/ravualhemio-weathermap-panel/partials/editor.html",2),this.addEditorTab("Nodes","public/plugins/ravualhemio-weathermap-panel/partials/nodeEditor.html",3),this.addEditorTab("Edges","public/plugins/ravualhemio-weathermap-panel/partials/edgeEditor.html",4),this.addEditorTab("Labels","public/plugins/ravualhemio-weathermap-panel/partials/labelEditor.html",5),this.addEditorTab("Styles","public/plugins/ravualhemio-weathermap-panel/partials/styleEditor.html",6)},t.prototype.onDataReceived=function(e){this.currentSeries=e.map(this.seriesHandler.bind(this)),this.currentValues=this.parseSeries(this.currentSeries),this.render()},t.prototype.seriesHandler=function(e){var t=new(S())({datapoints:e.datapoints,alias:e.target});return t.getFlotPairs(this.panel.nullPointMode),t},t.prototype.parseSeries=function(e){for(var t={},r=0,n=e;r<n.length;r++){var a=n[r];t[a.alias]=a.stats[this.panel.valueName]}return t},t.prototype.onDataSnapshotLoad=function(e){this.onDataReceived(e)},t.prototype.addWeathermapNode=function(e){this.panel.weathermapNodes.push(e||{})},t.prototype.removeWeathermapNode=function(e){this.panel.weathermapNodes=N().without(this.panel.weathermapNodes,e),this.refresh()},t.prototype.addWeathermapEdge=function(e){this.panel.weathermapEdges.push(e||{})},t.prototype.removeWeathermapEdge=function(e){this.panel.weathermapEdges=N().without(this.panel.weathermapEdges,e),this.refresh()},t.prototype.addWeathermapLabel=function(e){this.panel.weathermapLabels.push(e||{})},t.prototype.removeWeathermapLabel=function(e){this.panel.weathermapLabels=N().without(this.panel.weathermapLabels,e),this.refresh()},t.prototype.addWeathermapStyle=function(e){this.panel.weathermapStyles.push(e||{})},t.prototype.removeWeathermapStyle=function(e){this.panel.weathermapStyles=N().without(this.panel.weathermapStyles,e),this.refresh()},t.prototype.addGradientStop=function(e){this.panel.gradient.stops.push(e||{})},t.prototype.onGradientStopStrokeColorChange=function(e){var t=this;return function(r){t.panel.gradient.stops[e].strokeColor=r,t.refresh()}},t.prototype.onGradientStopFillColorChange=function(e){var t=this;return function(r){t.panel.gradient.stops[e].fillColor=r,t.refresh()}},t.prototype.removeGradientStop=function(e){this.panel.gradient.stops=N().without(this.panel.gradient.stops,e),this.refresh()},t.prototype.dashboardChanged=function(e){this.backendSrv.search({query:e.dashboard}).then((function(t){var r=N().find(t,{title:e.dashboard});r&&(e.dashUri=r.url)}))},t.prototype.link=function(e,t,r,n){var a=this;this.events.on("render",(function(){return a.renderThat(t[0],n)}))},t.prototype.renderThat=function(e,r){var n=e.querySelector("div.weathermap");if(null!==n){for(;n.lastChild;)n.removeChild(n.lastChild);y(document,n,this.panel,this.currentValues,t.resolveLink)}},t.resolveLink=function(e){if("absolute"===e.type&&e.absoluteUri)return e.absoluteUri;if("dashboard"===e.type&&e.dashUri){var t=function(e){var t=e.search;for(;t.startsWith("?");)t=t.substr(1);var r={};if(t.length>0)for(var n=0,a=t.split("&");n<a.length;n++){var i=a[n].match(/^([^=]*)(?:=(.*))?$/);if(null!==i){var o=i[1],s=i[2];void 0!==o&&void 0!==s&&(r[decodeURIComponent(o)]=decodeURIComponent(s))}}return r}(new URL(window.location.href)),r=[];t.from&&r.push("from="+encodeURIComponent(t.from)),t.to&&r.push("to="+encodeURIComponent(t.to));var n="";return r.length>0&&(n="?"+r.join("&")),"/dashboard/"+e.dashUri+n}return null},t}(e.MetricsPanelCtrl);M.templateUrl="partials/module.html"})(),o})()));
//# sourceMappingURL=module.js.map