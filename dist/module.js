define(["app/plugins/sdk","lodash","app/core/time_series2"],((t,e,n)=>(()=>{"use strict";var r={340:t=>{t.exports=n},735:e=>{e.exports=t},980:t=>{t.exports=e}},a={};function o(t){var e=a[t];if(void 0!==e)return e.exports;var n=a[t]={exports:{}};return r[t](n,n.exports,o),n.exports}o.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return o.d(e,{a:e}),e},o.d=(t,e)=>{for(var n in e)o.o(e,n)&&!o.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var i={};return(()=>{o.r(i),o.d(i,{PanelCtrl:()=>D});var t=o(735),e="ravualhemio-weathermap-panel",n="public/plugins/".concat(e,"/partials/editor.html"),r="public/plugins/".concat(e,"/partials/nodeEditor.html"),a="public/plugins/".concat(e,"/partials/edgeEditor.html"),s="public/plugins/".concat(e,"/partials/labelEditor.html"),l="public/plugins/".concat(e,"/partials/styleEditor.html"),c="http://www.w3.org/2000/svg";function p(t,e){return{x:(t.x+e.x)/2,y:(t.y+e.y)/2}}function u(t,e,n,r){if(null===e){if(null===n){var a=p(t,r);return[t,t,a,a,a,r,r]}e=t}null===n&&(n=r);var o=p(t,e),i=p(e,n),s=p(n,r),l=p(o,i),c=p(i,s);return[t,o,l,p(l,c),c,s,r]}function d(t,e){return null===t&&(t=0),null===e&&(e=0),{x:e*Math.cos(t),y:e*Math.sin(t)}}function h(t){for(;t<=-Math.PI;)t+=2*Math.PI;for(;t>Math.PI;)t-=2*Math.PI;return t}function f(t){return t*Math.PI/180}var y="pink";function m(t,e,n){return"linear"===t.type?function(t,e,n){if(0===t.length)return y;var r=t[t.length-1],a=0,o=0,i=0;if(n<t[0].position)return"".concat(t[0][e]);if(n>=r.position)return"".concat(r[e]);for(var s=!1,l=0;l<t.length-1;++l)if(n>=t[l].position&&n<t[l+1].position){var c=t[l].position,p=Number.parseInt("".concat(t[l][e]).substr(1,2),16),u=Number.parseInt("".concat(t[l][e]).substr(3,2),16),d=Number.parseInt("".concat(t[l][e]).substr(5,2),16),h=t[l+1].position,f=Number.parseInt("".concat(t[l+1][e]).substr(1,2),16),m=Number.parseInt("".concat(t[l+1][e]).substr(3,2),16),v=Number.parseInt("".concat(t[l+1][e]).substr(5,2),16);a=g(n,c,h,p,f),o=g(n,c,h,u,m),i=g(n,c,h,d,v),s=!0;break}if(!s)return y;return"rgb(".concat(Math.floor(a),", ").concat(Math.floor(o),", ").concat(Math.floor(i),")")}(t.stops,e,n):"steps"===t.type?function(t,e,n){if(0===t.length)return y;var r=t[t.length-1];if(n<t[0].position)return"".concat(t[0][e]);if(n>=r.position)return"".concat(r[e]);for(var a=0;a<t.length-1;++a)if(n>=t[a].position&&n<t[a+1].position)return"".concat(t[a][e]);return y}(t.stops,e,n):y}function g(t,e,n,r,a){return r===a?r:(t<e&&(t=e),t>n&&(t=n),r+(t-e)/(n-e)*(a-r))}var v=100;function b(t,e,n,r,a,o){var i="";if(""!==e.type){var s=t.g();n.appendChild(s),s.setAttribute("class","stroke-legend"),"h"===e.type[0]?i="translate(".concat(e.x," ").concat(e.y,")")+" scale(".concat(e.length/v," ").concat(e.width/5,")"):"v"===e.type[0]&&(i="translate(".concat(e.x," ").concat(e.y+e.length,")")+" rotate(-90)"+" scale(".concat(e.length/v," ").concat(e.width/5,")")),s.setAttribute("transform",i),x(t,a,"strokeColor",s,r,o);var l=t.g();n.appendChild(l),s.setAttribute("class","fill-legend"),"h"===e.type[0]?i="translate(".concat(e.x," ").concat(e.y+e.width,")")+" scale(".concat(e.length/v," ").concat(e.width/5,")"):"v"===e.type[0]&&(i="translate(".concat(e.x+e.width," ").concat(e.y+e.length,")")+" rotate(-90)"+" scale(".concat(e.length/v," ").concat(e.width/5,")")),l.setAttribute("transform",i),x(t,a,"fillColor",l,r,o),function(t,e,n,r){if(""===e.type||"n"===e.type[1])return;for(var a=0,o=n.stops;a<o.length;a++){var i=o[a];if(i.showLegendLabel){var s=e.x,l=e.y,c=0,p="start";"h"===e.type[0]?(s+=i.position*e.length/v,p="middle","hb"===e.type&&(l+=2*e.width,c=1)):"v"===e.type[0]&&(l+=e.length-i.position*e.length/v,c=.4,"vl"===e.type?p="end":"vr"===e.type&&(p="start",s+=2*e.width));var u=t.text();r.appendChild(u),u.setAttribute("class","legend-label"),u.setAttribute("x","".concat(s)),u.setAttribute("y","".concat(l)),u.setAttribute("dy","".concat(c,"em")),u.setAttribute("style","text-anchor:".concat(p)),u.textContent="".concat(i.position)}}}(t,e,a,n)}}function x(t,e,n,r,a,o){if("linear"===e.type){var i="WeathermapLegendGradient-".concat(n);null!=o&&(i="".concat(i,"-").concat(o));var s=t.linearGradient();a.appendChild(s),s.setAttribute("id",i);for(var l=0,c=e.stops;l<c.length;l++){var p=c[l],u=t.stop();s.appendChild(u),u.setAttribute("offset","".concat(p.position,"%")),u.setAttribute("stop-color","".concat(p[n]))}var d=t.rect();r.appendChild(d),N(d,0,0,v,5),d.setAttribute("style","fill:url(#".concat(i,")"))}else if("steps"===e.type){for(var h=1;h<e.stops.length;++h){var f=t.rect();r.appendChild(f),N(f,e.stops[h-1].position,0,e.stops[h].position-e.stops[h-1].position,5),f.setAttribute("style","fill:".concat(e.stops[h-1][n]))}var y=t.rect();r.appendChild(y),N(y,e.stops[e.stops.length-1].position,0,100-e.stops[e.stops.length-1].position,5),y.setAttribute("style","fill:".concat(e.stops[e.stops.length-1][n]))}}function w(t,e,n,r,a,o){void 0===o&&(o=!1);var i=n.gradient.stops.slice().sort((function(t,e){return t.position-e.position})),s={type:n.gradient.type,stops:i},l=new G(t,n,s,r);return function(t,e,n){void 0===n&&(n=!1);t.svg=t.make.svg(),A(t.svg,{width:"".concat(t.config.canvasSize.width,"px"),height:"".concat(t.config.canvasSize.height,"px")}),n&&t.svg.setAttribute("viewBox","0 0 ".concat(t.config.canvasSize.width," ").concat(t.config.canvasSize.height));e.appendChild(t.svg),t.defs=t.make.defs(),t.svg.appendChild(t.defs),t.legendGroup=t.make.g(),t.legendGroup.setAttribute("class","legend"),t.svg.appendChild(t.legendGroup),t.edgeGroup=t.make.g(),t.edgeGroup.setAttribute("class","edges"),t.svg.appendChild(t.edgeGroup),t.nodeGroup=t.make.g(),t.nodeGroup.setAttribute("class","nodes"),t.svg.appendChild(t.nodeGroup),t.labelGroup=t.make.g(),t.labelGroup.setAttribute("class","labels"),t.svg.appendChild(t.labelGroup)}(l,e,o),null!=a&&(l.nodeLinkUriBase=a(n.link.node),l.edgeLinkUriBase=a(n.link.edge)),function(t){for(var e=0,n=t.config.weathermapNodes;e<n.length;e++){var r=n[e];t.nodeLabelToNode[r.label]=r;var a=t.make.g();C(t.make,t.nodeGroup,a,t.nodeLinkUriBase,r.linkParams);var o=t.make.rect();a.appendChild(o),N(o,r.x,r.y,r.width,r.height),A(o,{stroke:"gray","stroke-width":"1px"});var i=t.make.text();if(a.appendChild(i),i.setAttribute("x","".concat(+r.x+ +t.config.textOffsets.left)),i.setAttribute("y","".concat(+r.y+ +r.height-t.config.textOffsets.bottom)),t.config.showNumbers&&null!=r.metricName){var s=r.metricName in t.currentValues?"".concat(t.currentValues[r.metricName]):"?";i.textContent="".concat(r.label," (").concat(s,")")}else i.textContent=r.label;var l=null;if(r.metricName?r.metricName in t.currentValues?(l=t.currentValues[r.metricName],A(o,{fill:m(t.sortedGradient,"fillColor",l)})):(A(i,{fill:"white"}),A(o,{fill:"black","stroke-dasharray":t.config.noValueDashArray})):A(o,{fill:"silver","stroke-dasharray":t.config.unmeasuredDashArray}),null!==l){var c=t.make.title();a.insertBefore(c,c.firstChild),c.textContent="".concat(r.label," (").concat(l.toFixed(2),")")}}}(l),function(t){for(var e=0,n=t.config.weathermapEdges;e<n.length;e++){var r=n[e],a=t.nodeLabelToNode[r.node1],o=t.nodeLabelToNode[r.node2];if(a&&o){var i=t.make.g();C(t.make,t.edgeGroup,i,t.edgeLinkUriBase,r.linkParams);var s={x:+a.x+ +a.width/2,y:+a.y+ +a.height/2},l={x:+o.x+ +o.width/2,y:+o.y+ +o.height/2},c=null,p=null;if(r.bendDirection&&r.bendMagnitude){var y=Math.atan2(s.y-l.y,l.x-s.x),m=Math.atan2(l.y-s.y,s.x-l.x),g=h(y+f(r.bendDirection)),v=h(m-f(r.bendDirection)),b=d(g,r.bendMagnitude),x=d(v,r.bendMagnitude);c={x:+s.x+b.x,y:+s.y-b.y},p={x:+l.x+x.x,y:+l.y-x.y}}if(r.metric2Name){var w=u(s,c,p,l),N=w[1],A=w[2],S=w[3],G=w[4],E=w[5];k(t,i,s,N,A,S,r.metricName,r.styleName,"".concat(r.node1," → ").concat(r.node2)),k(t,i,S,G,E,l,r.metric2Name,r.styleName,"".concat(r.node2," → ").concat(r.node1))}else k(t,i,s,c,p,l,r.metricName,r.styleName,"".concat(r.node1," ↔ ").concat(r.node2))}}}(l),function(t){for(var e=0,n=t.config.weathermapLabels;e<n.length;e++){var r=n[e],a=t.make.g();t.labelGroup.appendChild(a);var o=t.make.text();a.appendChild(o),o.setAttribute("x","".concat(+r.x)),o.setAttribute("y","".concat(+r.y)),o.textContent=r.label}}(l),b(l.make,n.legend,l.legendGroup,l.defs,s,"".concat(n.id)),l.svg}function k(t,e,n,r,a,o,i,s,l){var c=[t.config.strokeWidth],p=function(t,e){if(!e)return null;var n=t.styleMap[e];if(!n)return null;return n}(t,s);p&&p.strokeWidthArray&&(c=p.strokeWidthArray.split(/[ ,]+/).map((function(t){return Number.parseFloat(t)})));c.length%2!=1&&c.push.apply(c,c);var d,h,f={x:0,y:0};if(c.length>1){var y={x:n.x-o.x,y:n.y-o.y};d={x:y.y,y:-y.x},h=Math.sqrt(d.x*d.x+d.y*d.y),f={x:d.x/h,y:d.y/h}}var g=t.make.g();e.appendChild(g),A(g,{fill:"none"});var v=null;if(null!=i&&i in t.currentValues?(v=t.currentValues[i],A(g,{stroke:m(t.sortedGradient,"strokeColor",v)}),function(t,e,n){if(!n)return;var r={};n.dashArray&&(r["stroke-dasharray"]=n.dashArray);A(e,r)}(0,g,p)):A(g,{stroke:"black","stroke-dasharray":t.config.noValueDashArray}),l){var b=t.make.title();g.appendChild(b),b.textContent=null===v?l:"".concat(l," (").concat(v.toFixed(2),")")}for(var x=-c.reduce((function(t,e){return t+e}),0)/2,w=!0,k=0,C=c;k<C.length;k++){var N=C[k];if(w=!w)x+=N;else{var S=f.x*(x+N/2),G=f.y*(x+N/2),E={x:n.x+S,y:n.y+G},M=null==r?null:{x:r.x+S,y:r.y+G},L=null==a?null:{x:a.x+S,y:a.y+G},U={x:o.x+S,y:o.y+G},P=t.make.path();g.appendChild(P),null==M||null==L?P.setAttribute("d","M ".concat(E.x,",").concat(E.y," ")+"L ".concat(U.x,",").concat(U.y)):P.setAttribute("d","M ".concat(E.x,",").concat(E.y," ")+"C ".concat(M.x,",").concat(M.y,",").concat(L.x,",").concat(L.y,",").concat(U.x,",").concat(U.y)),A(P,{"stroke-width":"".concat(N)}),x+=N}}if(t.config.showNumbers){var O=u(n,r,a,o)[3],I=null!=i&&i in t.currentValues?t.currentValues[i].toFixed(2):"?",D=t.make.text();e.appendChild(D),D.setAttribute("x","".concat(O.x)),D.setAttribute("y","".concat(O.y)),D.textContent=I}}function C(t,e,n,r,a){if(null!=r){var o=r;null!=a&&(o+=-1===o.indexOf("?")?"?":"&",o+=a);var i=t.a();e.appendChild(i),i.setAttributeNS("http://www.w3.org/1999/xlink","href",o),i.appendChild(n)}else e.appendChild(n)}function N(t,e,n,r,a){t.setAttribute("x","".concat(e)),t.setAttribute("y","".concat(n)),t.setAttribute("width","".concat(r)),t.setAttribute("height","".concat(a))}function A(t,e){var n={};if(t.hasAttribute("style")){var r=t.getAttribute("style");if(null!=r)for(var a=0,o=r.split(";");a<o.length;a++){var i=o[a],s=i.indexOf(":");if(-1!==s){var l=i.substr(0,s),c=i.substr(s+1);n[l]=c}}}for(var l in e)e.hasOwnProperty(l)&&(null===e[l]?delete n[l]:n[l]=e[l]);var p=[];for(var l in n)n.hasOwnProperty(l)&&p.push("".concat(l,":").concat(n[l]));var u=p.join(";");t.setAttribute("style",u)}var S,G=function(t,e,n,r){if(this.make=new E(t),this.config=e,this.sortedGradient=n,this.currentValues=r,this.nodeLabelToNode={},this.nodeLinkUriBase=null,this.edgeLinkUriBase=null,this.svg=null,this.defs=null,this.edgeGroup=null,this.nodeGroup=null,this.labelGroup=null,this.legendGroup=null,this.styleMap={},e.weathermapStyles)for(var a=0,o=e.weathermapStyles;a<o.length;a++){var i=o[a];this.styleMap[i.name]=i}},E=function(){function t(t){this.maker=t}return t.prototype.a=function(){return this.maker.createElementNS(c,"a")},t.prototype.defs=function(){return this.maker.createElementNS(c,"defs")},t.prototype.g=function(){return this.maker.createElementNS(c,"g")},t.prototype.linearGradient=function(){return this.maker.createElementNS(c,"linearGradient")},t.prototype.path=function(){return this.maker.createElementNS(c,"path")},t.prototype.rect=function(){return this.maker.createElementNS(c,"rect")},t.prototype.stop=function(){return this.maker.createElementNS(c,"stop")},t.prototype.svg=function(){return this.maker.createElementNS(c,"svg")},t.prototype.text=function(){return this.maker.createElementNS(c,"text")},t.prototype.title=function(){return this.maker.createElementNS(c,"title")},t}(),M=o(980),L=o.n(M),U=o(340),P=o.n(U),O=(S=function(t,e){return S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},S(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}S(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),I={weathermapNodes:[],weathermapEdges:[],weathermapLabels:[],weathermapStyles:[],canvasSize:{width:800,height:600},textOffsets:{left:5,bottom:5},showNumbers:!1,valueName:"max",nullPointMode:"connected",strokeWidth:1,gradient:{type:"steps",stops:[]},legend:{type:"",x:0,y:0,length:100,width:5},link:{node:{type:"none",absoluteUri:null,dashboard:null,dashUri:null},edge:{type:"none",absoluteUri:null,dashboard:null,dashUri:null}},noValueDashArray:"4 4",unmeasuredDashArray:"4 2"},D=function(t){function e(e,n,r){var a=t.call(this,e,n)||this;return a.backendSrv=r,L().defaultsDeep(a.panel,I),a.currentValues={},a.events.on("init-edit-mode",a.onInitEditMode.bind(a)),a.events.on("data-received",a.onDataReceived.bind(a)),a.events.on("data-snapshot-load",a.onDataSnapshotLoad.bind(a)),a.searchDashboards=function(t,e){r.search({query:t}).then((function(t){var n=L().map(t,(function(t){return t.title}));e(n)}))},a}return e.$inject=["$scope","$injector","backendSrv"],O(e,t),e.prototype.onInitEditMode=function(){this.addEditorTab("Options",n,2),this.addEditorTab("Nodes",r,3),this.addEditorTab("Edges",a,4),this.addEditorTab("Labels",s,5),this.addEditorTab("Styles",l,6)},e.prototype.onDataReceived=function(t){this.currentSeries=t.map(this.seriesHandler.bind(this)),this.currentValues=this.parseSeries(this.currentSeries),this.render()},e.prototype.seriesHandler=function(t){var e=new(P())({datapoints:t.datapoints,alias:t.target});return e.getFlotPairs(this.panel.nullPointMode),e},e.prototype.parseSeries=function(t){for(var e={},n=0,r=t;n<r.length;n++){var a=r[n];e[a.alias]=a.stats[this.panel.valueName]}return e},e.prototype.onDataSnapshotLoad=function(t){this.onDataReceived(t)},e.prototype.addWeathermapNode=function(t){this.panel.weathermapNodes.push(t||{})},e.prototype.removeWeathermapNode=function(t){this.panel.weathermapNodes=L().without(this.panel.weathermapNodes,t),this.refresh()},e.prototype.addWeathermapEdge=function(t){this.panel.weathermapEdges.push(t||{})},e.prototype.removeWeathermapEdge=function(t){this.panel.weathermapEdges=L().without(this.panel.weathermapEdges,t),this.refresh()},e.prototype.addWeathermapLabel=function(t){this.panel.weathermapLabels.push(t||{})},e.prototype.removeWeathermapLabel=function(t){this.panel.weathermapLabels=L().without(this.panel.weathermapLabels,t),this.refresh()},e.prototype.addWeathermapStyle=function(t){this.panel.weathermapStyles.push(t||{})},e.prototype.removeWeathermapStyle=function(t){this.panel.weathermapStyles=L().without(this.panel.weathermapStyles,t),this.refresh()},e.prototype.addGradientStop=function(t){this.panel.gradient.stops.push(t||{})},e.prototype.onGradientStopStrokeColorChange=function(t){var e=this;return function(n){e.panel.gradient.stops[t].strokeColor=n,e.refresh()}},e.prototype.onGradientStopFillColorChange=function(t){var e=this;return function(n){e.panel.gradient.stops[t].fillColor=n,e.refresh()}},e.prototype.removeGradientStop=function(t){this.panel.gradient.stops=L().without(this.panel.gradient.stops,t),this.refresh()},e.prototype.dashboardChanged=function(t){this.backendSrv.search({query:t.dashboard}).then((function(e){var n=L().find(e,{title:t.dashboard});n&&(t.dashUri=n.url)}))},e.prototype.link=function(t,e,n,r){var a=this;this.events.on("render",(function(){return a.renderThat(e[0],r)}))},e.prototype.renderThat=function(t,n){var r=t.querySelector("div.weathermap");if(null!==r){for(;r.lastChild;)r.removeChild(r.lastChild);w(document,r,this.panel,this.currentValues,e.resolveLink)}},e.resolveLink=function(t){if("absolute"===t.type&&t.absoluteUri)return t.absoluteUri;if("dashboard"===t.type&&t.dashUri){var e=function(t){var e=t.search;for(;e.startsWith("?");)e=e.substr(1);var n={};if(e.length>0)for(var r=0,a=e.split("&");r<a.length;r++){var o=a[r].match(/^([^=]*)(?:=(.*))?$/);if(null!==o){var i=o[1],s=o[2];void 0!==i&&void 0!==s&&(n[decodeURIComponent(i)]=decodeURIComponent(s))}}return n}(new URL(window.location.href)),n=[];e.from&&n.push("from=".concat(encodeURIComponent(e.from))),e.to&&n.push("to=".concat(encodeURIComponent(e.to)));var r="";return n.length>0&&(r="?"+n.join("&")),"".concat(t.dashUri).concat(r)}return null},e}(t.MetricsPanelCtrl);D.templateUrl="partials/module.html"})(),i})()));
//# sourceMappingURL=module.js.map